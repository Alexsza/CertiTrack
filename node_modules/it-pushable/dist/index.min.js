(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.ItPushable = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var ItPushable=(()=>{var w=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var P=(i,e)=>{for(var r in e)w(i,r,{get:e[r],enumerable:!0})},A=(i,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let u of S(e))!_.call(i,u)&&u!==r&&w(i,u,{get:()=>e[u],enumerable:!(t=M(e,u))||t.enumerable});return i};var I=i=>A(w({},"__esModule",{value:!0}),i);var q={};P(q,{AbortError:()=>m,pushable:()=>R,pushableV:()=>j});function d(){let i={};return i.promise=new Promise((e,r)=>{i.resolve=e,i.reject=r}),i}var b=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},h=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new b(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let r=this.head;this.head=r.next=new b(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let r=this.tail.next;this.tail.next=null,this.tail=r,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var m=class extends Error{type;code;constructor(e,r){super(e??"The operation was aborted"),this.type="aborted",this.code=r??"ABORT_ERR"}};function R(i={}){return v(r=>{let t=r.shift();if(t==null)return{done:!0};if(t.error!=null)throw t.error;return{done:t.done===!0,value:t.value}},i)}function j(i={}){return v(r=>{let t,u=[];for(;!r.isEmpty()&&(t=r.shift(),t!=null);){if(t.error!=null)throw t.error;t.done===!1&&u.push(t.value)}return t==null?{done:!0}:{done:t.done===!0,value:u}},i)}function v(i,e){e=e??{};let r=e.onEnd,t=new h,u,l,c,a=d(),g=async()=>{try{let n;if(t.isEmpty()||(n=i(t)),n!=null)return n;if(c)return{done:!0}}finally{t.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=d()})}return new Promise((n,s)=>{l=p=>{l=null,t.push(p);try{n(i(t))}catch(o){s(o)}finally{t.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=d()})}return u}})},x=n=>l!=null?l(n):(t.push(n),u),z=n=>(t=new h,l!=null?l({error:n}):(t.push({error:n}),u)),E=n=>{if(c)return u;if(e?.objectMode!==!0&&n?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return x({done:!1,value:n})},y=n=>c?u:(c=!0,n!=null?z(n):x({done:!0})),L=()=>(t=new h,y(),{done:!0}),k=n=>(y(n),{done:!0});if(u={[Symbol.asyncIterator](){return this},next:g,return:L,throw:k,push:E,end:y,get readableLength(){return t.size},onEmpty:async n=>{let s=n?.signal;if(s?.throwIfAborted(),t.isEmpty())return;let p,o;s!=null&&(p=new Promise((T,N)=>{o=()=>{N(new m)},s.addEventListener("abort",o)}));try{await Promise.race([a.promise,p])}finally{o!=null&&s!=null&&s?.removeEventListener("abort",o)}}},r==null)return u;let f=u;return u={[Symbol.asyncIterator](){return this},next(){return f.next()},throw(n){return f.throw(n),r!=null&&(r(n),r=void 0),{done:!0}},return(){return f.return(),r!=null&&(r(),r=void 0),{done:!0}},push:E,end(n){return f.end(n),r!=null&&(r(n),r=void 0),u},get readableLength(){return f.readableLength}},u}return I(q);})();
return ItPushable}));
