<!DOCTYPE html>
<html>

<head>
	<title>Student page</title>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
	<style>

	</style>
</head>

<body>
	<nav class="navbar navbar-expand bg-light navigation-clean navbar-light">
	    <div class="container">
	        <a class="navbar-brand" href="#">CertiTrack</a>
	        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
	            <span class="navbar-toggler-icon"></span>
	        </button>

	        <div class="collapse navbar-collapse" id="navbarSupportedContent">
	            <ul class="navbar-nav mr-auto">
	                <li class="nav-item active">
	                    <a class="nav-link" href="/">Home </a>
	                </li>
	                <li class="nav-item">
	                    <a class="nav-link" href="/student">Student<span class="sr-only">(current)</span></a>
	                </li>
	                <li class="nav-item">
	                    <a class="nav-link" href="/validate">Validation</a>
	                </li>
	                <li class="nav-item">
	                    <a class="nav-link" href="/admin">Admin</a>
	                </li>
	                <li class="nav-item">
	                    <a class="nav-link" href="/contact">Contact</a>
	                </li>
	            </ul>
		     </div>
	    </div>
	</nav>

	<h1>Student page</h1>
	<div class="container">
		<div class="row">
			<div class="col-lg-6">
				<div id="leftContainer">
					<div id="readArea">
						<button onclick="connectMetamask()">CONNECT TO METAMASK</button>
						<p id="userArea">Status: Not connected to Metamask</p>

						<button onclick="connectContract()">CONNECT TO CONTRACT</button>
						<p id="contractArea">Status: Not connected to Contract</p>
						<button onclick="getNFTInfo()">Show NFT for Student ID:</button><br>

						<div id="bottomInfoContainer">
							<p id="tokenIdArea"></p>
							<p id="transferTimestampArea"></p>
						</div>
					</div>
				</div>
			</div>
			<div class="col-lg-6">
				<div id="rightContainer">
					<div id="nftInfoArea"></div>
				</div>
			</div>
		</div>
	</div>
    <footer class="bg-light footer">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 text-center text-lg-start my-auto h-100">
            <ul class="list-inline mb-2">
              <li class="list-inline-item"><a href="#">About</a></li>
              <li class="list-inline-item"><span> </span></li>
              <li class="list-inline-item"><a href="#">Contact</a></li>
              <li class="list-inline-item"><span> </span></li>
              <li class="list-inline-item"><a href="#">Terms of &nbsp;Use</a></li>
              <li class="list-inline-item"><span> </span></li>
              <li class="list-inline-item"><a href="#">Privacy Policy</a></li>
            </ul>
            <p class="text-muted small mb-4 mb-lg-0">Â© ASzW 2023. All Rights Reserved.</p>
          </div>
          <div class="col-lg-6 text-center text-lg-end my-auto h-100">
            <ul class="list-inline mb-0">
              <li class="list-inline-item"><a href="#"><i class="fa fa-facebook fa-2x fa-fw"></i></a></li>
              <li class="list-inline-item"><a href="#"><i class="fa fa-twitter fa-2x fa-fw"></i></a></li>
              <li class="list-inline-item"><a href="#"><i class="fa fa-instagram fa-2x fa-fw"></i></a></li>
            </ul>
          </div>
        </div>
      </div>
    </footer>

	<script>

		let account;
		const connectMetamask = async () => {
			if (window.ethereum !== "undefined") {
				const accounts = await ethereum.request({ method: "eth_requestAccounts" });
				account = accounts[0];
				document.getElementById("userArea").innerHTML = `User Account: ${account}`;
			}
		}


		const connectContract = async () => {
			const ABI = [
				{
					"anonymous": false,
					"inputs": [
						{
							"indexed": true,
							"internalType": "address",
							"name": "_owner",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "address",
							"name": "_approved",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "Approval",
					"type": "event"
				},
				{
					"anonymous": false,
					"inputs": [
						{
							"indexed": true,
							"internalType": "address",
							"name": "_owner",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "address",
							"name": "_operator",
							"type": "address"
						},
						{
							"indexed": false,
							"internalType": "bool",
							"name": "_approved",
							"type": "bool"
						}
					],
					"name": "ApprovalForAll",
					"type": "event"
				},
				{
					"anonymous": false,
					"inputs": [
						{
							"indexed": true,
							"internalType": "address",
							"name": "_to",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						},
						{
							"indexed": false,
							"internalType": "string",
							"name": "_uri",
							"type": "string"
						},
						{
							"indexed": false,
							"internalType": "uint256",
							"name": "_mintTimestamp",
							"type": "uint256"
						}
					],
					"name": "MintEvent",
					"type": "event"
				},
				{
					"anonymous": false,
					"inputs": [
						{
							"indexed": true,
							"internalType": "address",
							"name": "previousOwner",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "address",
							"name": "newOwner",
							"type": "address"
						}
					],
					"name": "OwnershipTransferred",
					"type": "event"
				},
				{
					"anonymous": false,
					"inputs": [
						{
							"indexed": true,
							"internalType": "address",
							"name": "_from",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "address",
							"name": "_to",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "Transfer",
					"type": "event"
				},
				{
					"anonymous": false,
					"inputs": [
						{
							"indexed": true,
							"internalType": "address",
							"name": "_from",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "address",
							"name": "_to",
							"type": "address"
						},
						{
							"indexed": true,
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						},
						{
							"indexed": false,
							"internalType": "uint256",
							"name": "_transferTimestamp",
							"type": "uint256"
						}
					],
					"name": "TransferEvent",
					"type": "event"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_approved",
							"type": "address"
						},
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "approve",
					"outputs": [],
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_to",
							"type": "address"
						},
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						},
						{
							"internalType": "string",
							"name": "_uri",
							"type": "string"
						},
						{
							"internalType": "uint256",
							"name": "_transferTimestamp",
							"type": "uint256"
						}
					],
					"name": "mint",
					"outputs": [],
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_from",
							"type": "address"
						},
						{
							"internalType": "address",
							"name": "_to",
							"type": "address"
						},
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "safeTransferFrom",
					"outputs": [],
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_from",
							"type": "address"
						},
						{
							"internalType": "address",
							"name": "_to",
							"type": "address"
						},
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						},
						{
							"internalType": "bytes",
							"name": "_data",
							"type": "bytes"
						}
					],
					"name": "safeTransferFrom",
					"outputs": [],
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_operator",
							"type": "address"
						},
						{
							"internalType": "bool",
							"name": "_approved",
							"type": "bool"
						}
					],
					"name": "setApprovalForAll",
					"outputs": [],
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_to",
							"type": "address"
						},
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "transfer",
					"outputs": [],
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_from",
							"type": "address"
						},
						{
							"internalType": "address",
							"name": "_to",
							"type": "address"
						},
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "transferFrom",
					"outputs": [],
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_newOwner",
							"type": "address"
						}
					],
					"name": "transferOwnership",
					"outputs": [],
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"inputs": [],
					"stateMutability": "nonpayable",
					"type": "constructor"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_owner",
							"type": "address"
						}
					],
					"name": "balanceOf",
					"outputs": [
						{
							"internalType": "uint256",
							"name": "",
							"type": "uint256"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [],
					"name": "CANNOT_TRANSFER_TO_ZERO_ADDRESS",
					"outputs": [
						{
							"internalType": "string",
							"name": "",
							"type": "string"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "getApproved",
					"outputs": [
						{
							"internalType": "address",
							"name": "",
							"type": "address"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "getTokenTransferTimestamp",
					"outputs": [
						{
							"internalType": "uint256",
							"name": "",
							"type": "uint256"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "address",
							"name": "_owner",
							"type": "address"
						},
						{
							"internalType": "address",
							"name": "_operator",
							"type": "address"
						}
					],
					"name": "isApprovedForAll",
					"outputs": [
						{
							"internalType": "bool",
							"name": "",
							"type": "bool"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [],
					"name": "name",
					"outputs": [
						{
							"internalType": "string",
							"name": "_name",
							"type": "string"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [],
					"name": "NOT_CURRENT_OWNER",
					"outputs": [
						{
							"internalType": "string",
							"name": "",
							"type": "string"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [],
					"name": "owner",
					"outputs": [
						{
							"internalType": "address",
							"name": "",
							"type": "address"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "ownerOf",
					"outputs": [
						{
							"internalType": "address",
							"name": "_owner",
							"type": "address"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "bytes4",
							"name": "_interfaceID",
							"type": "bytes4"
						}
					],
					"name": "supportsInterface",
					"outputs": [
						{
							"internalType": "bool",
							"name": "",
							"type": "bool"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [],
					"name": "symbol",
					"outputs": [
						{
							"internalType": "string",
							"name": "_symbol",
							"type": "string"
						}
					],
					"stateMutability": "view",
					"type": "function"
				},
				{
					"inputs": [
						{
							"internalType": "uint256",
							"name": "_tokenId",
							"type": "uint256"
						}
					],
					"name": "tokenURI",
					"outputs": [
						{
							"internalType": "string",
							"name": "",
							"type": "string"
						}
					],
					"stateMutability": "view",
					"type": "function"
				}
			];
			const Address = "0x27ade3b90a192f3b3969a13c6eae87d03541001a";
			window.web3 = await new Web3(window.ethereum);
			window.contract = await new window.web3.eth.Contract(ABI, Address);
			document.getElementById("contractArea").innerHTML = "Connected to Contract";
		}

		const getContractAccount = async () => {
			const data = await window.contract.methods.getAddress().call();
			document.getElementById("contractAccount").innerHTML = `Contract Account: ${data}`;
		}

		const getNFTInfo = async () => {
			const studentId = parseInt(prompt("Enter your studentID not including the 'x' \n (i.e. x22334455 - enter 22334455):"));
			const tokenOwner = await window.contract.methods.ownerOf(studentId).call();

			if (tokenOwner.toLowerCase() !== account.toLowerCase()) {
				const nftInfoArea = document.getElementById("nftInfoArea");
				nftInfoArea.innerHTML = "<p>This token is not associated with the current account.</p>";
			} else {
				const tokenUri = await window.contract.methods.tokenURI(studentId).call({ from: account });

				if (tokenUri !== null) {
					const nftInfoArea = document.getElementById("nftInfoArea");
					const transferTimestamp = await window.contract.methods.getTokenTransferTimestamp(studentId).call();

					const transferDateTime = new Date(transferTimestamp * 1000).toLocaleString();

					nftInfoArea.innerHTML = `
        <img src="${tokenUri}" alt="NFT Image" style="max-width: 80%; max-height: 80%;">
      `;

					const tokenIdArea = document.getElementById("tokenIdArea");
					tokenIdArea.textContent = `Token ID: ${studentId}`;

					const transferTimestampArea = document.getElementById("transferTimestampArea");
					transferTimestampArea.textContent = `Added to Blockchain on: ${transferDateTime}`;
				} else {
					console.log("No token found for the specified account.");

					const nftInfoArea = document.getElementById("nftInfoArea");
					nftInfoArea.innerHTML = "<p>No token found for the specified account.</p>";
				}
			}
		};

	</script>
</body>

</html>